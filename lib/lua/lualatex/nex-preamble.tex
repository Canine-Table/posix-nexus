\RequirePackage{ifluatex} % Checks if the document is compiled with LuaLaTeX
\ifluatex%
	\usepackage{luacode} % Allows embedding Lua code directly in LaTeX
	\catcode13=5 % ^^M
	\endlinechar=13 %
	\catcode35=6 % #
	\catcode39=12 % â€™
	\catcode40=12 % (
	\catcode41=12 % )
	\catcode44=12 % ,
	\catcode45=12 % -
	\catcode46=12 % .
	\catcode47=12 % /
	\catcode58=12 % :
	\catcode64=11 % @
	\catcode91=12 % [
	\catcode93=12 % ]
	\catcode123=1 % {
	\catcode125=2 % }
	\edef\nxPath{\directlua{tex.sprint(os.getenv('TEXMFHOME'))}}
	\AtBeginDocument{%
		\directlua{
			local nx_tex = os.getenv('TEXMFHOME')
			if nx_tex then
				local nx_lib = nx_tex:match('.*/')
				package.path = nx_tex .. '/?.lua;' .. nx_lib .. '/lua/?.lua;./opt/?.lua;./?.lua;../?.lua;' .. package.path
				texio.write_nl('Updated package.path: ' .. package.path)
				_G.nex = dofile(nx_tex .. '/nex-lualatex-init.lua')
			else
				texio.write_nl('Error: TEXMFHOME is not set!')
			end
		}%
	}%

%os.getenv('TEXCPL'):gsub('\\', '/'):match('[^/]+$') or 'luatex')

				%kpse.set_program_name('nex-lualatex-init')
				%_G.nex = require('nex-lualatex-init')
				%package.loaded['nex-lualatex-init'] = nil
				%local e, m = pcall(require, 'nex-lualatex-init')
				%if e then
				%	_G.nex = m
				%	texio.write_nl('Module ' .. m .. ' loaded successfully!')
				%else
				%	texio.write_nl('Error requiring module: ' .. m)
				%end

%	\makeatletter
	\input{\nxPath/nex-package.tex}
	\input{\nxPath/nex-color.tex}
	\input{\nxPath/nex-param.tex}
	\input{\nxPath/nex-misc.tex}
	\input{\nxPath/nex-register.tex}
	\input{\nxPath/nex-env.tex}
	\input{\nxPath/nex-renew.tex}
	\input{\nxPath/nex-box.tex}
	\input{\nxPath/nex-config.tex}
%	\makeatother
	\message{Posix-Nexus LuaLaTeX preamble fully loaded!}
\else%
	\PackageError{luacode}{LuaTeX is required, but not detected}{}%
\fi%

